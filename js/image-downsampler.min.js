/*!
 * Image Downsampler v1.0
 *  
 * Copyright (c) 2014, Fabian Prinz-Arnold <mail@addictivity.com>
 * 
 * Distributed under the MIT license.
 * All rights reserved.
 */
(function(e,t){if(typeof exports==="object"&&exports){t(exports)}else{var n={};t(n);if(typeof define==="function"&&define.amd){define(n)}else{e.ImageDownsampler=n}}})(this,function(e){var t={samples_x:10,samples_y:10,accuracy:5,bleed:10,async:false};var n=false;var r=function(e,n,r){if(e instanceof HTMLImageElement||typeof e==="object"){if(typeof n!=="object"){n=t}else{n=u(t,n)}if(n.async&&typeof r==="function"){a("execute asynchronous","executeDownsampling");setTimeout(function(){i(e,n,r)},0)}else if(!n.async){a("execute synchronous","executeDownsampling");return i(e,n)}else{a("set to async, but no callback provided","executeDownsampling");return false}}else{a("invalid image","executeDownsampling");return false}};var i=function(e,t,n){var r,i;if(e instanceof HTMLImageElement){r=s(e)}else{r=e}i=o(r.data,r.width,r.height,t);if(n!==undefined){n(i)}else{return i}};var s=function(e){if(e){var t=document.createElement("canvas");var n=t.getContext&&t.getContext("2d");var r=t.height=e.naturalHeight||e.offsetHeight||e.height;var i=t.width=e.naturalWidth||e.offsetWidth||e.width;try{n.drawImage(e,0,0)}catch(s){a("no image found. loaded?","createCanvas");return false}try{var o=n.getImageData(0,0,i,r)}catch(s){a("security error: wrong domain","createCanvas");return false}a("imagedata loaded "+o.width+"x"+o.height,"createCanvas")}return o};var o=function(e,t,n,r){a("analysing "+e.length+" subpixel","analyseImagedata");var i=[];for(var s=0;s<r.samples_x;s++){i[s]=[];for(var o=0;o<r.samples_y;o++){i[s][o]={r:0,g:0,b:0}}}var u={x:Math.floor((t-2*r.bleed)/r.samples_x),y:Math.floor((n-2*r.bleed)/r.samples_y)};a("accuracy "+r.accuracy+", pixel per sample: "+Math.ceil(u.x/r.accuracy)+"x"+Math.ceil(u.y/r.accuracy),"analyseImagedata");for(var s=0;s<r.samples_x;s++){for(var o=0;o<r.samples_y;o++){var f=s*u.x;var l=o*u.y;var c=0;var h={r:0,g:0,b:0};for(var p=0;p<u.x;p+=r.accuracy){for(var d=0;d<u.y;d+=r.accuracy){var v=(r.bleed+f+p+(r.bleed+l+d)*t)*4;h.r+=e[v];h.g+=e[v+1];h.b+=e[v+2];c++}}i[s][o]={r:~~(h.r/c),g:~~(h.g/c),b:~~(h.b/c)}}}return i};var u=function(e,t){var n={};for(var r in e){n[r]=e[r]}for(var r in t){n[r]=t[r]}return n};var a=function(e,t){if(n){if(t===undefined){t="n/a"}console.log("[ImageDownsampler] "+e+" @ "+t)}};e.run=r})