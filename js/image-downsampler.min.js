/*!
 * Image Downsampler v1.1
 * <https://github.com/Zephalon/ImageDownsampler>
 *  
 * Copyright (c) 2014, Fabian Prinz-Arnold <mail@addictivity.com>
 * 
 * Distributed under the MIT license.
 * All rights reserved.
 */

(function(e,t){if(typeof exports==="object"&&exports){t(exports)}else{var n={};t(n);if(typeof define==="function"&&define.amd){define(n)}else{e.ImageDownsampler=n}}})(this,function(e){var t={samples_x:10,samples_y:10,accuracy:5,bleed:5,async:true};var n=false;var r=function(e,n,r){if(typeof n!=="object"){n=t}else{n=a(t,n)}if(typeof e==="string"){n.async=true;i(e,n,r)}else if(e instanceof HTMLImageElement||typeof e==="object"){if(n.async&&typeof r==="function"){f("execute asynchronous","executeDownsampling");setTimeout(function(){s(e,n,r)},0)}else if(!n.async){f("execute synchronous","executeDownsampling");return s(e,n)}else{f("set to async, but no callback provided","executeDownsampling");return false}}else{f("invalid image","executeDownsampling");return false}};var i=function(e,t,n){f("preloading image: "+e,"preloadImage");var i=new Image;i.src=e;i.onload=function(){r(this,t,n)}};var s=function(e,t,n){var r,i;if(e instanceof HTMLImageElement){r=o(e)}else{r=e}i=u(r.data,r.width,r.height,t);if(n!==undefined){n(i)}else{return i}};var o=function(e){if(e instanceof HTMLImageElement){var t=document.createElement("canvas");var n=t.getContext&&t.getContext("2d");var r=t.height=e.naturalHeight||e.offsetHeight||e.height;var i=t.width=e.naturalWidth||e.offsetWidth||e.width;try{n.drawImage(e,0,0)}catch(s){f("no image found. loaded?","getImagedata");return false}try{var o=n.getImageData(0,0,i,r)}catch(s){f("security error: wrong domain","getImagedata");return false}f("imagedata loaded "+o.width+"x"+o.height,"getImagedata");return o}else{f("no image found","getImagedata");return false}};var u=function(e,t,n,r){f("analysing "+e.length+" subpixel","analyseImagedata");var i=[];for(var s=0;s<r.samples_x;s++){i[s]=[];for(var o=0;o<r.samples_y;o++){i[s][o]={r:0,g:0,b:0}}}var u={x:Math.floor((t-2*r.bleed)/r.samples_x),y:Math.floor((n-2*r.bleed)/r.samples_y)};f("accuracy "+r.accuracy+", pixel per sample: "+Math.ceil(u.x/r.accuracy)+"x"+Math.ceil(u.y/r.accuracy),"analyseImagedata");for(var s=0;s<r.samples_x;s++){for(var o=0;o<r.samples_y;o++){var a=s*u.x;var l=o*u.y;var c=0;var h={r:0,g:0,b:0};for(var p=0;p<u.x;p+=r.accuracy){for(var d=0;d<u.y;d+=r.accuracy){var v=(r.bleed+a+p+(r.bleed+l+d)*t)*4;h.r+=e[v];h.g+=e[v+1];h.b+=e[v+2];c++}}i[s][o]={r:~~(h.r/c),g:~~(h.g/c),b:~~(h.b/c)}}}return i};var a=function(e,t){var n={};for(var r in e){n[r]=e[r]}for(var r in t){n[r]=t[r]}return n};var f=function(e,t){if(n){if(t===undefined){t="n/a"}console.log("[ImageDownsampler] "+e+" @ "+t)}};e.run=r;e.get=o})